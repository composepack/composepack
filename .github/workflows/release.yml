name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  IMAGE_NAME: garearc/composepack

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Run tests
        run: go test ./...
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ github.ref_name }}
        run: |
          mkdir -p dist
          BIN_NAME=composepack
          if [[ "$GOOS" == "windows" ]]; then
            BIN_NAME="composepack.exe"
          fi
          go build -ldflags "-s -w -X composepack/internal/version.Version=$VERSION" -o "dist/${BIN_NAME}" ./cmd/composepack
      - name: Prepare artifact
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ github.ref_name }}
        run: |
          mkdir -p release
          if [[ "$GOOS" == "windows" ]]; then
            cp dist/composepack.exe "release/composepack-${GOOS}-${GOARCH}.exe"
          else
            # Package non-Windows binaries into tar.gz for distribution
            tar -C dist -czf "release/composepack_${VERSION}_${GOOS}_${GOARCH}.tar.gz" composepack
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: composepack-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            release/composepack-${{ matrix.goos }}-${{ matrix.goarch }}*
            release/composepack_${{ github.ref_name }}_${{ matrix.goos }}_${{ matrix.goarch }}*.tar.gz
          if-no-files-found: ignore

  publish:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build and Publish Docker Image
    runs-on: ubuntu-latest
    needs: [build, publish]
    permissions:
      contents: read
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract Linux binaries and prepare Docker contexts
        run: |
          mkdir -p docker-binaries/amd64 docker-binaries/arm64
          # Extract amd64 binary
          tar -xzf artifacts/composepack-linux-amd64/composepack_${VERSION}_linux_amd64.tar.gz -C docker-binaries/amd64
          # Extract arm64 binary
          tar -xzf artifacts/composepack-linux-arm64/composepack_${VERSION}_linux_arm64.tar.gz -C docker-binaries/arm64
          # Copy Dockerfile to each context
          cp Dockerfile docker-binaries/amd64/
          cp Dockerfile docker-binaries/arm64/

      - name: Build and push amd64 image
        uses: docker/build-push-action@v5
        with:
          context: docker-binaries/amd64
          file: docker-binaries/amd64/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.VERSION }}-amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push arm64 image
        uses: docker/build-push-action@v5
        with:
          context: docker-binaries/arm64
          file: docker-binaries/arm64/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.VERSION }}-arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create and push multi-arch manifests
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          # Create manifest for version tag
          docker buildx imagetools create -t ${{ env.IMAGE_NAME }}:${VERSION} \
            ${{ env.IMAGE_NAME }}:${VERSION}-amd64 \
            ${{ env.IMAGE_NAME }}:${VERSION}-arm64

          # Create manifest for latest tag
          docker buildx imagetools create -t ${{ env.IMAGE_NAME }}:latest \
            ${{ env.IMAGE_NAME }}:${VERSION}-amd64 \
            ${{ env.IMAGE_NAME }}:${VERSION}-arm64

  homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: [build, publish]
    env:
      VERSION: ${{ github.ref_name }}
      REPO_SLUG: ${{ github.repository }}
      HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
      HOMEBREW_TAP_REPO: ${{ vars.HOMEBREW_TAP_REPO }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Determine tap repository
        id: taprepo
        run: |
          if [ -n "${HOMEBREW_TAP_REPO}" ]; then
            echo "tap=${HOMEBREW_TAP_REPO}" >> "$GITHUB_OUTPUT"
          else
            echo "tap=${GITHUB_REPOSITORY_OWNER}/homebrew-tap" >> "$GITHUB_OUTPUT"
          fi
      - name: Compute macOS checksums
        id: shas
        run: |
          set -euo pipefail
          AMD64_TARBALL=$(ls artifacts/**/composepack_${VERSION}_darwin_amd64.tar.gz)
          ARM64_TARBALL=$(ls artifacts/**/composepack_${VERSION}_darwin_arm64.tar.gz)
          echo "amd64: $AMD64_TARBALL"
          echo "arm64: $ARM64_TARBALL"
          SHA_AMD64=$(sha256sum "$AMD64_TARBALL" | awk '{print $1}')
          SHA_ARM64=$(sha256sum "$ARM64_TARBALL" | awk '{print $1}')
          echo "sha_darwin_amd64=$SHA_AMD64" >> "$GITHUB_OUTPUT"
          echo "sha_darwin_arm64=$SHA_ARM64" >> "$GITHUB_OUTPUT"
      - name: Compute Linux checksums
        id: shas_linux
        run: |
          set -euo pipefail
          AMD64_TARBALL=$(ls artifacts/**/composepack_${VERSION}_linux_amd64.tar.gz)
          ARM64_TARBALL=$(ls artifacts/**/composepack_${VERSION}_linux_arm64.tar.gz)
          echo "linux amd64: $AMD64_TARBALL"
          echo "linux arm64: $ARM64_TARBALL"
          SHA_AMD64=$(sha256sum "$AMD64_TARBALL" | awk '{print $1}')
          SHA_ARM64=$(sha256sum "$ARM64_TARBALL" | awk '{print $1}')
          echo "sha_linux_amd64=$SHA_AMD64" >> "$GITHUB_OUTPUT"
          echo "sha_linux_arm64=$SHA_ARM64" >> "$GITHUB_OUTPUT"
      - name: Generate Homebrew formula
        run: |
          mkdir -p out
          bash scripts/gen-brew-formula.sh "$VERSION" "$REPO_SLUG" out/composepack.rb \
            "${{ steps.shas.outputs.sha_darwin_amd64 }}" "${{ steps.shas.outputs.sha_darwin_arm64 }}" \
            "${{ steps.shas_linux.outputs.sha_linux_amd64 }}" "${{ steps.shas_linux.outputs.sha_linux_arm64 }}"
          echo "Generated formula:"
          cat out/composepack.rb
      - name: Upsert formula in tap via API
        if: ${{ env.HOMEBREW_TAP_GITHUB_TOKEN != '' }}
        env:
          GH_TOKEN: ${{ env.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh --version
          TAP_REPO="${{ steps.taprepo.outputs.tap }}"
          DEFAULT_BRANCH=$(gh repo view "$TAP_REPO" --json defaultBranchRef -q .defaultBranchRef.name || echo "main")
          echo "Using branch: $DEFAULT_BRANCH"
          mkdir -p Formula
          cp out/composepack.rb Formula/composepack.rb
          # Get existing file SHA if present
          SHA=$(gh api -X GET -H "Accept: application/vnd.github+json" \
                 "/repos/${TAP_REPO}/contents/Formula/composepack.rb?ref=${DEFAULT_BRANCH}" -q .sha 2>/dev/null || echo "")
          # Base64 encode content
          if base64 -w 0 Formula/composepack.rb >/tmp/content.b64 2>/dev/null; then :; else base64 < Formula/composepack.rb | tr -d '\n' >/tmp/content.b64; fi
          # Build request
          if [[ -n "$SHA" && "$SHA" != "null" ]]; then
            gh api -X PUT -H "Accept: application/vnd.github+json" \
              "/repos/${TAP_REPO}/contents/Formula/composepack.rb" \
              -f message="composepack ${VERSION}: update formula" \
              -f content="$(cat /tmp/content.b64)" \
              -f branch="${DEFAULT_BRANCH}" \
              -f sha="${SHA}"
          else
            gh api -X PUT -H "Accept: application/vnd.github+json" \
              "/repos/${TAP_REPO}/contents/Formula/composepack.rb" \
              -f message="composepack ${VERSION}: add formula" \
              -f content="$(cat /tmp/content.b64)" \
              -f branch="${DEFAULT_BRANCH}"
          fi
